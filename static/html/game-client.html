<html>
  <body>
    <script src="http://localhost:9810/compile?id=client"></script>
    <script>

var _ = ble.telephone_pictionary;
var transform = goog.result.transform;
var SimpleResult = goog.result.SimpleResult;
var server = _.ServerModel.initialize(window);
goog.events.listen(
  server,
  [_.EventType.JOIN,
   _.EventType.PASS,
   _.EventType.LOADED,
   _.EventType.START,
   _.EventType.CHAT],
  function(event) {
    console.log("GOT AN EVENT");
    console.log(event);
  });
server.wireUp();
server.run();

var myTopDrawing = function() {
  var error = new SimpleResult();

  var game = server.game;
  if(!game.isStarted()) {
    error.setError("game not started");
    return error;
  }

  var me = game.myPlayer();
  if(!me) {
    error.setError("client not associated with a player");
    return error;
  }
  var stacks = me.stacksHeld();
  if(!stacks || stacks.length == 0) {
    error.setError("player doesn't have stacks");
    return error;
  }
  var topStack = stacks[0];

  var fetchStack = topStack.fetchState();
  var theDrawing = null;
  var withStackLoaded = function() {
    var drawings = topStack.drawings();
    if(!drawings || drawings.length == 0) {
      error.setError("no drawings");
      return error;
    }
    theDrawing = drawings[0];
    return drawings[0].fetchState();
  };
  var fetchDrawing = transform(fetchStack, withStackLoaded);

  var withDrawingLoaded = function(response) {
    if(response.getError() !== undefined)
      return response
    if(!theDrawing || !theDrawing.content()) {
      error.setError("didn't get drawing");
      return error;
    }
    var content = new SimpleResult();
    content.setValue(theDrawing);
  };
  var drawingContent = transform(fetchDrawing, withDrawingLoaded);
  return drawingContent;

};
      /*

client.chat("What's up in this piece?");
//a bunch of testing stuff
//check if we're holding a stack, asynchronously update its contents
var withStartedGame = function() {
  var me = game.myPlayer();
  var myStacks = me.stacksHeld();
  if(myStacks.length < 1)
    return;
  var topStack = myStacks[0];
  var request = topStack.fetchState();
  request.wait(goog.bind(withLoadedStack, this, topStack));
};

//get the top drawing of the stack, asynchronously fetch its contents
var withLoadedStack = function(topStack) {
  var topDrawing = topStack.drawings()[0];
  var request = topDrawing.fetchState();
  request.wait(goog.bind(withLoadedDrawing, this, topDrawing));
};

//just show that we got the drawing
var withLoadedDrawing = function(topDrawing) {
  console.log(topDrawing.player());
  console.log(topDrawing.content());
};


//When we're done getting the initial game state...
fetchRequest.wait(function(result) {
  if(result.getError() !== undefined) {
    return;
  }

  //start the game if need be and wait for stacks to be passed...
  if(!game.isStarted()) {
    var request = client.startGame();
    goog.events.listen(game, _.EventType.PASS, withStartedGame);
  } else {
  //if the game's already started, we should already have stacks
    withStartedGame();
  }
});
*/


    </script>
  </body>
</html>
