<html>
  <body>
    <script src="http://localhost:9810/compile?id=client"></script>
    <script>
var _ = ble.telephone_pictionary;
var url = location.toString();
url = url.replace(/\/[^\/]*$/, '/');
var client = new _.ClientImpl(url);
var game = new _.GameImpl(client);
var comet = new ble.net.QueryTimeComet(url + 'events');
/**
 @constructor
 @param {ble.telephone_pictionary.GameUpdater} game
**/
var PassiveHandler = function(game) {
  this.game = game;
};

PassiveHandler.prototype.handleEvent = function(event) {
  //console.log(event);
  var text = event['responseText'];
  if(text === undefined) {
    console.error('missing response text');
    return;
  }
  var obj = JSON.parse(text);
  var events = obj['events'];
  if(events === undefined) {
    console.error('missing events');
    return;
  }
  for(var i = 0; i < events.length; i++) {
    var gameEvent = events[i];
    var type = gameEvent['actionType'];
    switch(type) {
    case 'joinGame':
      console.log(gameEvent['who']);
      console.log(gameEvent['name']);
      this.game.joinGame(gameEvent['who'], gameEvent['name'], false);
      break;
    case 'chat':
      //TODO: wire this up to the chat UI
      break;
    case 'startGame':
      game.startGame(gameEvent['who']);
      break;
    case 'passStack':
      game.passStack(gameEvent['who'], gameEvent['toWhom'], gameEvent['stackId'], gameEvent['url']);
      break;
    }
    console.log(events[i]);
  }
};

client.chat("What's up in this piece?");

var handler = new PassiveHandler(game);
comet.listen(ble.net.EventType.COMET_DATA, handler);

game.listen([_.EventType.JOIN, _.EventType.PASS, _.EventType.START], function(event) {
  console.log("A GAME EVENT OCCURRED:");
  console.log(event);
});

var fetchRequest = game.fetchState();
fetchRequest.wait(function(result) {
  if(result.getError() !== undefined) {
    console.error(result.getError());
    return;
  }
  var value = result.getValue();
  var time = value['lastTime'];
  if(time === undefined) {
    console.error('didn\'t get a time');
    return
  }

  console.log(value);
  comet.runAt(time);
});



    </script>
  </body>
</html>
